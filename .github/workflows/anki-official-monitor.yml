name: ğŸš¨ Anki Official Files Monitor

on:
  schedule:
    - cron: '30 4 * * *'
  workflow_dispatch:

jobs:
  check_for_changes:
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡º THIS repository (ç”¨äºè¯»å–å’Œå†™å…¥ä¸Šæ¬¡çš„ SHA)
      - name: Checkout THIS repository
        uses: actions/checkout@v4
        with:
          path: self-repo
          
      # 2. å…‹éš† Anki å®˜æ–¹ä»“åº“çš„æœ€æ–°çŠ¶æ€
      - name: Clone Anki Official Repository
        uses: actions/checkout@v4
        with:
          repository: ankitects/anki
          path: anki-official
      
      # 3. æ£€æŸ¥æ–‡ä»¶å˜åŠ¨å¹¶è·å– SHA
      - name: Check for Changes and Get Current SHA
        id: diff_check
        run: |
          # å®šä¹‰å…³é”®æ–‡ä»¶è·¯å¾„
          FILE_PATH_DOCKER="anki-official/docs/syncserver/Dockerfile"
          FILE_PATH_ENTRYPOINT="anki-official/docs/syncserver/entrypoint.sh"
          
          # è·å–å½“å‰ Anki ä»“åº“çš„æœ€æ–° commit SHA
          CURRENT_SHA=$(git -C anki-official rev-parse HEAD)
          echo "CURRENT_SHA=$CURRENT_SHA" >> $GITHUB_OUTPUT
          
          # å°è¯•è¯»å–ä¸Šæ¬¡ä¿å­˜çš„ SHA
          LAST_SHA=""
          if [ -f self-repo/last_anki_sha.txt ]; then
              LAST_SHA=$(cat self-repo/last_anki_sha.txt)
          fi
          
          echo "ä¸Šæ¬¡ SHA: $LAST_SHA"
          echo "æœ¬æ¬¡ SHA: $CURRENT_SHA"

          # å¦‚æœä¸Šæ¬¡ SHA ä¸å­˜åœ¨æˆ–ä¸å½“å‰ SHA ç›¸åŒï¼Œåˆ™æ— éœ€é€šçŸ¥
          if [ -z "$LAST_SHA" ] || [ "$LAST_SHA" = "$CURRENT_SHA" ]; then
              echo "NOTIFY=false" >> $GITHUB_OUTPUT
              exit 0
          fi

          # *** æ¯”è¾ƒå·®å¼‚ï¼šæ–‡ä»¶å†…å®¹æˆ–ç»“æ„å˜åŠ¨ ***
          
          # æ£€æŸ¥ Dockerfile å’Œ entrypoint.sh çš„å†…å®¹å·®å¼‚
          DIFF_DOCKER=$(git -C anki-official diff $LAST_SHA $CURRENT_SHA -- $FILE_PATH_DOCKER)
          DIFF_ENTRYPOINT=$(git -C anki-official diff $LAST_SHA $CURRENT_SHA -- $FILE_PATH_ENTRYPOINT)

          DIFF_BODY=""
          if [ -n "$DIFF_DOCKER" ]; then
              DIFF_BODY+="- [Dockerfile] å‘ç”Ÿå†…å®¹å˜åŠ¨ã€‚\n"
          fi
          if [ -n "$DIFF_ENTRYPOINT" ]; then
              DIFF_BODY+="- [entrypoint.sh] å‘ç”Ÿå†…å®¹å˜åŠ¨ã€‚\n"
          fi
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦è¢«åˆ é™¤/ç§»åŠ¨ (ç»“æ„å˜åŠ¨)
          if [ ! -f "$FILE_PATH_DOCKER" ] || [ ! -f "$FILE_PATH_ENTRYPOINT" ]; then
              DIFF_BODY+="- [ç»“æ„å˜åŠ¨] å…³é”®æ–‡ä»¶ç¼ºå¤±æˆ–ç›®å½•å·²ç§»åŠ¨ã€‚\n"
          fi

          if [ -n "$DIFF_BODY" ]; then
              echo "NOTIFICATION_BODY=$DIFF_BODY" >> $GITHUB_OUTPUT
              echo "NOTIFY=true" >> $GITHUB_OUTPUT
          else
              echo "NOTIFY=false" >> $GITHUB_OUTPUT
          fi


      # 4. åˆ›å»º Issue é€šçŸ¥
      - name: Create Issue Notification
        if: steps.diff_check.outputs.NOTIFY == 'true'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const notificationBody = "${{ steps.diff_check.outputs.NOTIFICATION_BODY }}";
            const currentSha = "${{ steps.diff_check.outputs.CURRENT_SHA }}";
            const repoOwner = context.repo.owner;
            
            const issueTitle = `ğŸš¨ Anki å®˜æ–¹é…ç½®å˜åŠ¨ï¼šDockerfile/Entrypoint å†…å®¹å·²æ›´æ–°`;
            const issueBody = `
            @${repoOwner}ï¼Œæ‚¨çš„ Anki åŒæ­¥æœåŠ¡å™¨æ„å»ºä¾èµ–çš„å®˜æ–¹é…ç½®å·²å‘ç”Ÿå˜åŠ¨ã€‚è¯·æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–° \`sync-server-ci.yml\` ä¸­çš„ä¾èµ–é¡¹ã€‚

            **å˜åŠ¨æ‘˜è¦ï¼š**
            ${notificationBody}

            **Git Diff é“¾æ¥ (æœ¬æ¬¡å˜åŠ¨):**
            https://github.com/ankitects/anki/compare/${{ steps.diff_check.outputs.LAST_SHA }}..${currentSha}

            æœ¬æ¬¡æ£€æŸ¥çš„ Anki Commit SHA: \`${currentSha}\`
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody
            });

      # 5. æ›´æ–° SHA æ–‡ä»¶ï¼ˆæ— è®ºæ˜¯å¦é€šçŸ¥ï¼Œéƒ½å¿…é¡»æ›´æ–°ï¼‰
      - name: Update Last Known SHA
        run: |
          # å†™å…¥æœ€æ–°çš„ SHA åˆ°æ–‡ä»¶
          echo "${{ steps.diff_check.outputs.CURRENT_SHA }}" > last_anki_sha.txt
          
      # 6. æäº¤ SHA æ–‡ä»¶åˆ°ä½ çš„ä»“åº“
      - name: Commit SHA Update
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'CI: Update last known Anki SHA for monitoring'
          file_pattern: 'last_anki_sha.txt'
          repository: self-repo # æäº¤åˆ°è‡ªå·±çš„ä»“åº“
