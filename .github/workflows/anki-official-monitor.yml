name: ðŸš¨ Anki Official Files Monitor

on:
  # æ¯å¤©è¿è¡Œä¸€æ¬¡ï¼Œæ£€æŸ¥å˜åŠ¨
  schedule:
    - cron: '30 4 * * *'
  workflow_dispatch:

jobs:
  check_for_changes:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout THIS repository
        uses: actions/checkout@v4
        
      # 1. å…‹éš† Anki å®˜æ–¹ä»“åº“çš„æœ€æ–°çŠ¶æ€
      - name: Clone Anki Official Repository
        uses: actions/checkout@v4
        with:
          repository: ankitects/anki
          path: anki-official
          # ä½¿ç”¨ GITHUB_TOKENï¼Œé¿å…é€ŸçŽ‡é™åˆ¶

      # 2. æ£€æŸ¥å…³é”®æ–‡ä»¶çš„å˜åŠ¨
      - name: Check for Changes in Critical Files
        id: diff_check
        run: |
          CRITICAL_FILES=(
              "anki-official/docs/syncserver/Dockerfile"
              "anki-official/docs/syncserver/entrypoint.sh"
          )
          
          MISSING_FILES=()
          for file in "${CRITICAL_FILES[@]}"; do
              if [ ! -f "$file" ]; then
                  MISSING_FILES+=("$(basename "$file")") # åªèŽ·å–æ–‡ä»¶å
              fi
          done

          if [ ${#MISSING_FILES[@]} -ne 0 ]; then
              echo "MISSING_FILES_LIST=${MISSING_FILES[*]}" >> $GITHUB_OUTPUT
              echo "::warning::Critical files are missing or moved!"
              echo "NOTIFY=true" >> $GITHUB_OUTPUT
          else
              echo "NOTIFY=false" >> $GITHUB_OUTPUT
          fi


      # 3. åˆ›å»º GitHub Issue é€šçŸ¥
      - name: Create Issue Notification
        if: steps.diff_check.outputs.NOTIFY == 'true'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const missingFiles = "${{ steps.diff_check.outputs.MISSING_FILES_LIST }}";
            const repoOwner = context.repo.owner;
            const repoName = context.repo.repo;
            
            const issueTitle = `ðŸš¨ Anki å®˜æ–¹ SyncServer æ–‡ä»¶ç»“æž„å˜åŠ¨ï¼`;
            const issueBody = `
            @${repoOwner}ï¼Œæ‚¨çš„ Anki åŒæ­¥æœåŠ¡å™¨æž„å»ºä¾èµ–çš„å®˜æ–¹æ–‡ä»¶ç»“æž„å¯èƒ½å·²æ”¹å˜ã€‚
            
            è¯·æ³¨æ„ï¼š
            - æž„å»ºæµç¨‹ä¾èµ–çš„æ–‡ä»¶è·¯å¾„å¯èƒ½å·²å¤±æ•ˆã€‚
            - æ‚¨çš„ \`sync-server-ci.yml\` æ–‡ä»¶ä¸­çš„æ–‡ä»¶å¤åˆ¶æ­¥éª¤ï¼ˆ\`cp\`ï¼‰å¯èƒ½éœ€è¦æ›´æ–°ã€‚
            
            **ç¼ºå¤±æˆ–å·²ç§»åŠ¨çš„æ–‡ä»¶ï¼š**
            ${missingFiles.split(' ').map(f => `- ${f}`).join('\n')}
            
            è¯·æ£€æŸ¥ Anki å®˜æ–¹ä»“åº“ï¼šhttps://github.com/ankitects/anki
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody
            });
