name: ğŸš¨ Anki Official Files Monitor

on:
  schedule:
    - cron: '30 4 * * *' # ä¿ç•™å®šæ—¶æ‰§è¡Œï¼Œç”¨äºå®šæœŸæ£€æŸ¥
  workflow_dispatch:

jobs:
  check_for_changes:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write 
      issues: write # ç”¨äºåˆ›å»º Issue
      actions: write # ğŸŒŸ å…³é”®ï¼šæ–°å¢ actions æƒé™ï¼Œç”¨äºè§¦å‘æ„å»ºå·¥ä½œæµ

    steps:
      # 1. ä¿®æ­£ï¼šæ£€å‡º THIS repository åˆ°é»˜è®¤å·¥ä½œåŒºæ ¹ç›®å½•
      - name: Checkout THIS repository
        uses: actions/checkout@v4
        
      # 2. å…‹éš† Anki å®˜æ–¹ä»“åº“åˆ°å­ç›®å½•
      - name: Clone Anki Official Repository
        uses: actions/checkout@v4
        with:
          repository: ankitects/anki
          path: anki-official
          fetch-depth: 0 # ç¡®ä¿è·å–å®Œæ•´å†å²ä»¥æ¯”è¾ƒ SHA

      
      # 3. æ£€æŸ¥æ–‡ä»¶å˜åŠ¨ã€è·å– SHA å’Œ Tag
      - name: Check for Changes and Get Current SHA & Tag
        id: diff_check
        run: |
          FILE_PATH_DOCKER="anki-official/docs/syncserver/Dockerfile"
          FILE_PATH_ENTRYPOINT="anki-official/docs/syncserver/entrypoint.sh"
          
          # è·å–å½“å‰ Commit SHA
          CURRENT_SHA=$(git -C anki-official rev-parse HEAD)
          echo "CURRENT_SHA=$CURRENT_SHA" >> $GITHUB_OUTPUT
          
          # è·å–ä¸Šæ¬¡å­˜å‚¨çš„ SHA
          LAST_SHA=""
          if [ -f last_anki_sha.txt ]; then
              LAST_SHA=$(cat last_anki_sha.txt)
          fi
          
          # ğŸŒŸ ä¿®æ­£ï¼šæŸ¥æ‰¾æœ€æ–°çš„å®˜æ–¹ç‰ˆæœ¬ Tag (ç§»é™¤ '2.*' é™åˆ¶ï¼Œæ”¯æŒæ‰€æœ‰ç‰ˆæœ¬)
          CURRENT_TAG=$(git -C anki-official describe --tags --abbrev=0)
          echo "CURRENT_TAG=$CURRENT_TAG" >> $GITHUB_OUTPUT

          # è·å–ä¸Šæ¬¡å­˜å‚¨çš„ Tag
          LAST_TAG=""
          if [ -f last_anki_tag.txt ]; then
              LAST_TAG=$(cat last_anki_tag.txt)
          fi
          
          # --- å˜åŠ¨åˆ¤æ–­é€»è¾‘ ---
          SHA_CHANGED="false"
          if [ -z "$LAST_SHA" ] || [ "$LAST_SHA" != "$CURRENT_SHA" ]; then
              SHA_CHANGED="true"
          fi

          TAG_CHANGED="false"
          if [ -z "$LAST_TAG" ] || [ "$LAST_TAG" != "$CURRENT_TAG" ]; then
              TAG_CHANGED="true"
          fi
          
          # ä¼˜å…ˆåˆ¤æ–­ Tag å˜åŠ¨
          if [ "$TAG_CHANGED" = "true" ]; then
              echo "TAG_CHANGED=true" >> $GITHUB_OUTPUT
              echo "NOTIFICATION_BODY=- [ç‰ˆæœ¬å˜åŠ¨] å‘ç°æ–°ç‰ˆæœ¬ Tag: ${CURRENT_TAG}ã€‚\n" >> $GITHUB_OUTPUT
              echo "NOTIFY=true" >> $GITHUB_OUTPUT
              exit 0 
          fi
          
          echo "TAG_CHANGED=false" >> $GITHUB_OUTPUT
          
          # å¦‚æœ Tag æœªå˜ï¼Œç»§ç»­æ£€æŸ¥æ–‡ä»¶å†…å®¹æ˜¯å¦å˜åŠ¨
          if [ "$SHA_CHANGED" = "false" ]; then
              echo "NOTIFY=false" >> $GITHUB_OUTPUT
              exit 0
          fi
          
          # æ£€æŸ¥æ–‡ä»¶å†…å®¹å˜åŠ¨
          DIFF_DOCKER=$(git -C anki-official diff $LAST_SHA $CURRENT_SHA -- $FILE_PATH_DOCKER)
          DIFF_ENTRYPOINT=$(git -C anki-official diff $LAST_SHA $CURRENT_SHA -- $FILE_PATH_ENTRYPOINT)

          DIFF_BODY=""
          if [ -n "$DIFF_DOCKER" ]; then
              DIFF_BODY+="- [Dockerfile] å‘ç”Ÿå†…å®¹å˜åŠ¨ã€‚\n"
          fi
          if [ -n "$DIFF_ENTRYPOINT" ]; then
              DIFF_BODY+="- [entrypoint.sh] å‘ç”Ÿå†…å®¹å˜åŠ¨ã€‚\n"
          fi
          
          if [ ! -f "$FILE_PATH_DOCKER" ] || [ ! -f "$FILE_PATH_ENTRYPOINT" ]; then
              DIFF_BODY+="- [ç»“æ„å˜åŠ¨] å…³é”®æ–‡ä»¶ç¼ºå¤±æˆ–ç›®å½•å·²ç§»åŠ¨ã€‚\n"
          fi

          if [ -n "$DIFF_BODY" ]; then
              echo "NOTIFICATION_BODY=$DIFF_BODY" >> $GITHUB_OUTPUT
              echo "NOTIFY=true" >> $GITHUB_OUTPUT
          else
              echo "NOTIFY=false" >> $GITHUB_OUTPUT
          fi


      # 4. åˆ›å»º Issue é€šçŸ¥
      - name: Create Issue Notification
        if: steps.diff_check.outputs.NOTIFY == 'true'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const notificationBody = "${{ steps.diff_check.outputs.NOTIFICATION_BODY }}";
            const currentSha = "${{ steps.diff_check.outputs.CURRENT_SHA }}";
            const currentTag = "${{ steps.diff_check.outputs.CURRENT_TAG }}";
            const repoOwner = context.repo.owner;
            
            let issueTitle = 'ğŸš¨ Anki å®˜æ–¹é…ç½®å˜åŠ¨ï¼š';
            if ("${{ steps.diff_check.outputs.TAG_CHANGED }}" === 'true') {
                issueTitle = `ğŸš€ Anki å®˜æ–¹å‘å¸ƒæ–°ç‰ˆæœ¬ï¼š${currentTag}ï¼Œå·²è‡ªåŠ¨è§¦å‘æ„å»º`;
            } else {
                issueTitle += 'Dockerfile/Entrypoint å†…å®¹å·²æ›´æ–°';
            }
            
            const issueBody = `
            @${repoOwner}ï¼Œæ‚¨çš„ Anki åŒæ­¥æœåŠ¡å™¨æ„å»ºä¾èµ–çš„å®˜æ–¹é…ç½®å·²å‘ç”Ÿå˜åŠ¨ã€‚è¯·æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–° \`build-and-push.yml\` ä¸­çš„ä¾èµ–é¡¹ã€‚

            **å˜åŠ¨æ‘˜è¦ï¼š**
            ${notificationBody}

            **Git Diff é“¾æ¥ (æœ¬æ¬¡å˜åŠ¨):**
            https://github.com/ankitects/anki/compare/${{ steps.diff_check.outputs.LAST_SHA }}..${currentSha}

            æœ¬æ¬¡æ£€æŸ¥çš„ Anki Commit SHA: \`${currentSha}\`
            `;
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody
            });

      # ğŸŒŸ 4.5 è§¦å‘æ„å»ºå·¥ä½œæµ
      - name: Trigger Build Workflow
        if: steps.diff_check.outputs.TAG_CHANGED == 'true'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const newTag = "${{ steps.diff_check.outputs.CURRENT_TAG }}";
            
            // è§¦å‘ build-and-push.yml
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-and-push.yml', 
              ref: context.ref, 
              inputs: {
                tag: newTag
              }
            });

      # 5. æ›´æ–° SHA æ–‡ä»¶
      - name: Update Last Known SHA
        run: |
          echo "${{ steps.diff_check.outputs.CURRENT_SHA }}" > last_anki_sha.txt
      
      # ğŸŒŸ 5.5 æ›´æ–° Tag æ–‡ä»¶
      - name: Update Last Known Tag
        if: steps.diff_check.outputs.TAG_CHANGED == 'true'
        run: |
          echo "${{ steps.diff_check.outputs.CURRENT_TAG }}" > last_anki_tag.txt
          
      # 6. æäº¤ SHA å’Œ Tag æ–‡ä»¶åˆ°ä½ çš„ä»“åº“
      - name: Commit SHA and Tag Update
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'CI: Update last known Anki SHA and Tag for monitoring'
          file_pattern: 'last_anki_sha.txt last_anki_tag.txt'
