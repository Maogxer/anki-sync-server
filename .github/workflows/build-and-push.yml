name: ğŸ”„ Anki Sync Server Auto-Build and Push

# è§¦å‘å™¨ï¼š
on:
  # å…è®¸åœ¨ GitHub ç•Œé¢æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:
  
  # å®šæœŸè¿è¡Œ (Cron Job): ä¾‹å¦‚ï¼Œæ¯å‘¨ä¸€å‡Œæ™¨ 03:00 UTC è¿è¡Œï¼Œæ£€æŸ¥æ–°ç‰ˆæœ¬
  schedule:
    - cron: '0 3 * * 1' 
    
jobs:
  build_and_push:
    runs-on: ubuntu-latest
    
    # å®šä¹‰ç¯å¢ƒå˜é‡ï¼Œä» Secrets ä¸­è·å–æ•æ„Ÿä¿¡æ¯
    env:
      DOCKER_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_HUB_TOKEN }}
      # âš ï¸ æ›¿æ¢ä¸ºä½ è‡ªå·±çš„ Docker Hub ç”¨æˆ·åæˆ–ç»„ç»‡å
      DOCKER_REPO: maogxer/anki-sync-server 
      
    steps:
      # 1. æ£€å‡ºä½ çš„ä»“åº“
      - name: Checkout your repository
        uses: actions/checkout@v4
      
      # 2. å®‰è£… JQï¼Œç”¨äºè§£æ JSON å“åº”
      - name: Install dependencies (jq)
        run: sudo apt-get update && sudo apt-get install -y jq
      
      # 3. æŸ¥æ‰¾æœ€æ–°çš„ Anki å®˜æ–¹ç¨³å®šç‰ˆæœ¬ (Git Tag)
      - name: Get latest Anki official release tag
        id: get_tag
        run: |
          # ä» Anki å®˜æ–¹ä»“åº“è·å–æœ€æ–°çš„ Git Tag
          ANKI_TAG=$(curl -s "https://api.github.com/repos/ankitects/anki/tags?per_page=1" | jq -r '.[0].name' | sed 's/^Anki //g')
          
          if [ -z "$ANKI_TAG" ]; then
            echo "::error::Failed to retrieve Anki tag."
            exit 1
          fi
          
          echo "Latest Anki Tag found: ${ANKI_TAG}"
          echo "version=$ANKI_TAG" >> $GITHUB_OUTPUT
      
      # 4. å…‹éš† Anki å®˜æ–¹æºç ä»“åº“
      - name: Clone Anki Official Repository
        uses: actions/checkout@v4
        with:
          repository: ankitects/anki
          ref: ${{ steps.get_tag.outputs.version }}
          path: anki-official
          
      # 5. ğŸ› ï¸ å…³é”®ä¿®å¤ï¼šæ›´æ–° Dockerfile ä¸­çš„è¿‡æ—¶ Rust ç‰ˆæœ¬
      - name: Override Dockerfile with Latest Rust Version and Setup Build Directory
        run: |
          # 1. åˆ›å»ºæ„å»ºæ‰€éœ€çš„ä¸´æ—¶ç›®å½•
          mkdir -p ./.docker-build
          
          # 2. å¤åˆ¶å®˜æ–¹ Dockerfile å’Œ entrypoint.sh åˆ°ä¸´æ—¶ç›®å½•
          cp ./anki-official/docs/syncserver/Dockerfile ./.docker-build/Dockerfile
          cp ./anki-official/docs/syncserver/entrypoint.sh ./.docker-build/entrypoint.sh
          
          # 3. ä½¿ç”¨ sed å‘½ä»¤æ›¿æ¢æ—§çš„ Rust ç‰ˆæœ¬ (1.85.0) ä¸ºæœ€æ–°çš„ç¨³å®šç‰ˆæœ¬ 1.87.0
          # è¿™è§£å†³äº†ç¼–è¯‘å¤±è´¥ (exit code 101) çš„é—®é¢˜
          sed -i 's/FROM rust:1.85.0-alpine3.20/FROM rust:1.87.0-alpine3.20/' ./.docker-build/Dockerfile
          
          echo "Modified Dockerfile content (first 5 lines):"
          head -n 5 ./.docker-build/Dockerfile

      # 6. ğŸ› ï¸ å…³é”®ä¿®å¤ï¼šè®¾ç½® Buildx æ„å»ºå™¨ä»¥æ”¯æŒç¼“å­˜å¯¼å‡º
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
          
      # 7. ç™»å½• Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}
     #
     # ... (åœ¨æ­¥éª¤ 7: ç™»å½• Docker Hub ä¹‹å)
      - name: Debug Print Version Variables
        run: |
         echo "Expected ANKI Version: ${{ steps.get_tag.outputs.version }}"
         echo "Full Tag String 1: ${{ env.DOCKER_REPO }}:${{ steps.get_tag.outputs.version }}"
         echo "Full Tag String 2: ${{ env.DOCKER_REPO }}:latest"

     # 8. æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          # ğŸ› ï¸ ä¿®å¤æ–‡ä»¶æ‰¾ä¸åˆ°é—®é¢˜ï¼šä½¿ç”¨åŒ…å«ä¿®æ”¹åæ–‡ä»¶çš„ä¸´æ—¶ç›®å½•ä½œä¸ºä¸Šä¸‹æ–‡
          context: ./.docker-build 
          # æŒ‡å®š Dockerfile è·¯å¾„
          file: ./.docker-build/Dockerfile 
          push: true
          # ä¼ é€’ ANKI_VERSION å‚æ•°ç»™ Dockerfile
          build-args: ANKI_VERSION=${{ steps.get_tag.outputs.version }} 
          # æ‰“ä¸Šç‰ˆæœ¬å·æ ‡ç­¾å’Œ latest æ ‡ç­¾
          tags: |
            ${{ env.DOCKER_REPO }}:${{ steps.get_tag.outputs.version }}
            ${{ env.DOCKER_REPO }}:latest
          # ç¼“å­˜è®¾ç½®ï¼Œç°åœ¨ Buildx å·²è®¾ç½®ï¼Œç¼“å­˜åº”è¯¥èƒ½æ­£å¸¸å·¥ä½œ
          cache-from: type=gha
          cache-to: type=gha,mode=max
