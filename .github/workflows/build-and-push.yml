name: ğŸ”„ Anki Sync Server Auto-Build and Push

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 1' 
    
jobs:
  build_and_push:
    runs-on: ubuntu-latest
    
    env:
      DOCKER_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_HUB_TOKEN }}
      DOCKER_REPO: maogxer/anki-sync-server 
      
    steps:
      - name: Checkout your repository
        uses: actions/checkout@v4
      
      - name: Install dependencies (jq)
        run: sudo apt-get update && sudo apt-get install -y jq
      
      # æ™ºèƒ½æŸ¥æ‰¾æœ€æ–°çš„ç¨³å®šç‰ˆæœ¬ (è·³è¿‡æµ‹è¯•Tag)
      - name: Get latest stable Anki Tag
        id: get_tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -o pipefail
          
          echo "--- Fetching Anki Tags ---"
          
          STABLE_TAG=""
          
          API_RESPONSE=$(curl -s -L \
            -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/repos/ankitects/anki/tags?per_page=10")
          
          if [ $? -ne 0 ]; then
            echo "::error::Curl failed to retrieve GitHub API data."
            exit 1
          fi

          TAG_LIST=$(echo "$API_RESPONSE" | jq -r '.[].name')
          
          for TAG in $TAG_LIST; do
            CLEAN_TAG=$(echo "$TAG" | sed 's/^Anki //g')
            
            if [[ "$CLEAN_TAG" =~ ^[0-9]+\.[0-9]+\.?[0-9]*$ ]]; then
                STABLE_TAG="$CLEAN_TAG"
                break
            fi
          done

          if [ -z "$STABLE_TAG" ]; then
            echo "::error::No stable Anki Tag found among the latest 10 tags."
            exit 1
          fi

          echo "Latest STABLE Anki Tag found: ${STABLE_TAG}"
          echo "version=$STABLE_TAG" >> $GITHUB_OUTPUT
      
      - name: Clone Anki Official Repository
        uses: actions/checkout@v4
        with:
          repository: ankitects/anki
          ref: ${{ steps.get_tag.outputs.version }}
          path: anki-official
          
      - name: Override Dockerfile with Latest Rust Version and Setup Build Directory
        run: |
          mkdir -p ./.docker-build
          
          cp ./anki-official/docs/syncserver/Dockerfile ./.docker-build/Dockerfile
          cp ./anki-official/docs/syncserver/entrypoint.sh ./.docker-build/entrypoint.sh
          
          
          sed -i 's/FROM rust:1.85.0-alpine3.20/FROM rust:1.87.0-alpine3.20/' ./.docker-build/Dockerfile
          
          echo "Modified Dockerfile content (first 5 lines):"
          head -n 5 ./.docker-build/Dockerfile

      # ğŸŒŸ æ–°å¢ï¼šè®¾ç½® QEMU ä»¥å¯ç”¨äº¤å‰ç¼–è¯‘
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
          
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}
          
      # å¤šå¹³å°æ„å»ºä¸æ¨é€
      - name: Build and push Multi-Arch Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./.docker-build 
          file: ./.docker-build/Dockerfile 
          push: true
          # ğŸŒŸ å…³é”®ï¼šæŒ‡å®šè¦æ„å»ºçš„ä¸¤ä¸ªå¹³å°
          platforms: linux/amd64,linux/arm64 
          build-args: ANKI_VERSION=${{ steps.get_tag.outputs.version }} 
          tags: |
            ${{ env.DOCKER_REPO }}:${{ steps.get_tag.outputs.version }}
            ${{ env.DOCKER_REPO }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
