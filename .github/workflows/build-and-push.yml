# .github/workflows/build-and-push.yml

name: Anki Sync Server - Automated Tagged Build

on:
  # 每天凌晨 3 点 UTC 触发构建
  schedule:
    - cron: '0 3 * * *'
  # 允许手动触发
  workflow_dispatch:

env:
  # 替换为您的 Docker Hub 用户名
  IMAGE_NAME: magxer/anki-sync-server 
  # 使用 Secrets 赋值给环境变量，供后续 steps 使用
  DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
  DOCKER_HUB_TOKEN: ${{ secrets.DOCKER_HUB_TOKEN }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      # 0. 确保您的本地仓库被 Checkout，以便获取您自己的 Dockerfile
      - name: Checkout Local Repository
        uses: actions/checkout@v4
        
      # =========================================================
      # 1. 动态获取 Anki 官方仓库的最新稳定标签
      # =========================================================
      - name: Get Latest Anki Release Tag
        id: get_tag
        run: |
          # 调用 GitHub API 获取 Anki 官方仓库的最新 Release Tag
          LATEST_TAG=$(curl -s https://api.github.com/repos/ankitects/anki/releases/latest | jq -r .tag_name)
          
          if [ -z "$LATEST_TAG" ]; then
            echo "Error: Could not retrieve latest tag from Anki repository."
            exit 1
          fi
          
          echo "Latest Anki Tag found: $LATEST_TAG"
          # 设置输出变量，供后续步骤使用
          echo "ANKI_TAG=$LATEST_TAG" >> $GITHUB_OUTPUT
          
      # =========================================================
      # 2. 克隆 Anki 源码仓库（使用获取到的最新标签）
      # =========================================================
      - name: Checkout Anki repository (Tagged Version)
        uses: actions/checkout@v4
        with:
          repository: ankitects/anki
          ref: ${{ steps.get_tag.outputs.ANKI_TAG }}
          path: anki-repo  # 官方源码克隆到 anki-repo 目录

      # =========================================================
      # 3. 复制您本地的 Dockerfile 到源码目录 (构建上下文)
      # =========================================================
      # 必须在 anki-repo 目录下执行构建，所以将 Dockerfile 复制过去
      - name: Copy Dockerfile to context
        # 假设您的 Dockerfile 位于您本地仓库的根目录
        run: cp Dockerfile anki-repo/

      # =========================================================
      # 4. 设置 Docker Buildx 并登录
      # =========================================================
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_HUB_USERNAME }}
          password: ${{ env.DOCKER_HUB_TOKEN }}

      # =========================================================
      # 5. 构建并推送多平台镜像
      # =========================================================
      - name: Build and push multi-arch Docker image
        uses: docker/build-push-action@v5
        with:
          # context: 设置为官方仓库代码的根目录，这是构建上下文
          context: anki-repo 
          
          # file: Dockerfile 位于 anki-repo 目录的根部
          file: anki-repo/Dockerfile 
          
          platforms: linux/amd64,linux/arm64 
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_NAME }}:${{ steps.get_tag.outputs.ANKI_TAG }} 
            
          cache-from: type=gha
          cache-to: type=gha,mode=max
