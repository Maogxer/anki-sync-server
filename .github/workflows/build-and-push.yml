name: ğŸ”„ Anki Sync Server Auto-Build and Push

# è§¦å‘å™¨ï¼š
on:
  # å…è®¸åœ¨ GitHub ç•Œé¢æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:
  
  # å®šæœŸè¿è¡Œ (Cron Job): ä¾‹å¦‚ï¼Œæ¯å‘¨ä¸€å‡Œæ™¨ 03:00 UTC è¿è¡Œï¼Œæ£€æŸ¥æ–°ç‰ˆæœ¬
  schedule:
    - cron: '0 3 * * 1' 
  
  # å¦‚æœä½ æƒ³åœ¨æ¯æ¬¡æäº¤åˆ° main åˆ†æ”¯æ—¶æ„å»ºï¼Œå¯ä»¥æ·»åŠ ï¼š
  # push:
  #   branches: [ main ]
    
jobs:
  build_and_push:
    runs-on: ubuntu-latest
    
    # ç¡®ä¿ secrets å·²ç»é…ç½®ï¼Œå¦åˆ™æ— æ³•æ‰§è¡Œåç»­çš„ç™»å½•å’Œæ¨é€
    environment:
      name: DockerHub
    
    # å®šä¹‰ç¯å¢ƒå˜é‡ï¼Œä» Secrets ä¸­è·å–æ•æ„Ÿä¿¡æ¯
    env:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
      # è¯·å°† YOUR_DOCKER_HUB_NAMESPACE æ›¿æ¢ä¸ºä½ çš„ Docker Hub ç”¨æˆ·åæˆ–ç»„ç»‡å
      DOCKER_REPO: maogxer/anki-sync-server 
      
    steps:
      # 1. æ£€å‡ºä½ çš„ä»“åº“ (å¯é€‰ï¼Œä½†æ¨è)
      - name: Checkout your repository
        uses: actions/checkout@v4
      
      # 2. å®‰è£… JQï¼Œç”¨äºè§£æ JSON å“åº”
      - name: Install dependencies (jq)
        run: sudo apt-get update && sudo apt-get install -y jq
      
      # 3. æŸ¥æ‰¾æœ€æ–°çš„ Anki å®˜æ–¹ç¨³å®šç‰ˆæœ¬ (Git Tag)
      - name: Get latest Anki official release tag
        id: get_tag
        run: |
          # ä» Anki å®˜æ–¹ä»“åº“è·å–æœ€æ–°çš„ Git Tagã€‚
          # ç»“æœç¤ºä¾‹: "25.09" æˆ– "25.10.1"
          ANKI_TAG=$(curl -s "https://api.github.com/repos/ankitects/anki/tags?per_page=1" | jq -r '.[0].name' | sed 's/^Anki //g')
          
          if [ -z "$ANKI_TAG" ]; then
            echo "::error::Failed to retrieve Anki tag."
            exit 1
          fi
          
          echo "Latest Anki Tag found: ${ANKI_TAG}"
          
          # å°†ç‰ˆæœ¬å·ä½œä¸ºè¾“å‡ºï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "version=$ANKI_TAG" >> $GITHUB_OUTPUT
      
      # 4. å…‹éš† Anki å®˜æ–¹æºç ä»“åº“
      - name: Clone Anki Official Repository
        uses: actions/checkout@v4
        with:
          repository: ankitects/anki
          ref: ${{ steps.get_tag.outputs.version }} # ä½¿ç”¨æœ€æ–°çš„ Tag æ£€å‡ºç‰¹å®šç‰ˆæœ¬
          path: anki-official
          
      # 5. ç™»å½• Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}
          
      # 6. æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          # æ„å»ºä¸Šä¸‹æ–‡æ˜¯å®˜æ–¹ä»“åº“çš„ç›®å½•
          context: ./anki-official 
          # Dockerfile è·¯å¾„åœ¨å®˜æ–¹ä»“åº“çš„ docs/syncserver/
          file: ./anki-official/docs/syncserver/Dockerfile 
          push: true
          # ä¼ é€’ ANKI_VERSION å‚æ•°ç»™ Dockerfile
          build-args: ANKI_VERSION=${{ steps.get_tag.outputs.version }} 
          # æ‰“ä¸Šç‰ˆæœ¬å·æ ‡ç­¾å’Œ latest æ ‡ç­¾
          tags: |
            ${{ env.DOCKER_REPO }}:${{ steps.get_tag.outputs.version }}
            ${{ env.DOCKER_REPO }}:latest
          # ç¼“å­˜è®¾ç½®
          cache-from: type=gha
          cache-to: type=gha,mode=max
