name: ğŸš€ Automated Build and Deploy

on:
  # ğŸŒŸ å…³é”®ï¼šä»…é€šè¿‡ workflow_dispatch è§¦å‘ï¼Œæ¥æ”¶ tag å‚æ•°
  workflow_dispatch:
    inputs:
      tag:
        description: 'New Anki Version Tag to build'
        required: true
        type: string
      sha:
        description: 'Commit SHA (Optional)'
        required: false
        type: string

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    
    env:
      DOCKER_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_HUB_TOKEN }}
      DOCKER_REPO: maogxer/anki-sync-server 
      
    steps:
      - name: Checkout your repository
        uses: actions/checkout@v4
      
      # ğŸŒŸ ç§»é™¤ï¼šä¸å†éœ€è¦ Install dependencies (jq) å’Œ Get latest stable Anki Tag æ­¥éª¤

      - name: Clone Anki Official Repository at Specified Tag
        uses: actions/checkout@v4
        with:
          repository: ankitects/anki
          # ğŸŒŸ å…³é”®ï¼šä½¿ç”¨è¾“å…¥å‚æ•°ä¸­çš„ Tag ä½œä¸ºå…‹éš†çš„å¼•ç”¨
          ref: ${{ github.event.inputs.tag }} 
          path: anki-official
          
      - name: Override Dockerfile with Latest Rust Version and Setup Build Directory
        run: |
          mkdir -p ./.docker-build
          
          # æ‹·è´å®˜æ–¹ Dockerfile å’Œ entrypoint.sh
          cp ./anki-official/docs/syncserver/Dockerfile ./.docker-build/Dockerfile
          cp ./anki-official/docs/syncserver/entrypoint.sh ./.docker-build/entrypoint.sh
          
          # ä¿ç•™æ‚¨çš„ sed æ›¿æ¢
          sed -i 's/FROM rust:1.85.0-alpine3.20/FROM rust:1.87.0-alpine3.20/' ./.docker-build/Dockerfile
          
          echo "Modified Dockerfile content (first 5 lines):"
          head -n 5 ./.docker-build/Dockerfile

      # è®¾ç½® QEMU
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
          
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}
          
      # å¤šå¹³å°æ„å»ºä¸æ¨é€
      - name: Build and push Multi-Arch Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./.docker-build 
          file: ./.docker-build/Dockerfile 
          push: true
          platforms: linux/amd64,linux/arm64 
          # ğŸŒŸ å…³é”®ï¼šä½¿ç”¨ä¼ å…¥çš„ Tag
          build-args: ANKI_VERSION=${{ github.event.inputs.tag }} 
          tags: |
            ${{ env.DOCKER_REPO }}:${{ github.event.inputs.tag }}
            ${{ env.DOCKER_REPO }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
